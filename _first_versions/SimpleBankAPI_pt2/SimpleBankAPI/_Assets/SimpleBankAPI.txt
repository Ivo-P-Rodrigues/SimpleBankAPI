
-- Database: SimpleBankAPI

-- DROP DATABASE IF EXISTS "SimpleBankAPI";
/*
CREATE DATABASE "SimpleBankAPI"
    WITH
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'English_United Kingdom.1252'
    LC_CTYPE = 'English_United Kingdom.1252'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

COMMENT ON DATABASE "SimpleBankAPI"
    IS 'Simple Bank API';
    
*/


DROP TABLE IF EXISTS "Transfers";
DROP TABLE IF EXISTS "Movements";
DROP TABLE IF EXISTS "Accounts";
DROP TABLE IF EXISTS "Sessions";
DROP TABLE IF EXISTS "Users";


CREATE TABLE "Users"(
   User_id    SERIAL PRIMARY KEY NOT NULL,
   Email            VARCHAR(320) NOT NULL,
   Fullname                 TEXT NOT NULL,
   "Password"              BYTEA NOT NULL,
   Salt                    BYTEA NOT NULL,
   Username                 TEXT NOT NULL,
   Created_at          TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP),
   Password_changed_at TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP),
CONSTRAINT Check_MinLength_Users_FullName CHECK (LENGTH(FullName) >= 16),
CONSTRAINT Check_MinLength_Users_Username CHECK (LENGTH(Username) >= 8),
CONSTRAINT UNIQUE_Users_Email    UNIQUE (Email),
CONSTRAINT UNIQUE_Users_Username UNIQUE (Username)
);
    
CREATE TABLE "Accounts"(
   Account_id SERIAL PRIMARY KEY NOT NULL,
   User_id                INT NOT NULL,
   Balance            NUMERIC NOT NULL,
   Created_at       TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP),
   Currency           CHAR(3) NOT NULL DEFAULT ('EUR'),
   CONSTRAINT Check_Accounts_Balance_Positive CHECK (Balance > 0), -- to give error on a test of accountBusiness - createAccount
CONSTRAINT Account_User_fkey FOREIGN KEY (User_id)
    REFERENCES "Users" (User_id) MATCH SIMPLE
    ON UPDATE NO ACTION ON DELETE NO ACTION,
CONSTRAINT Check_Accounts_Currency_Length CHECK (LENGTH(Currency) = 3)
);
    
CREATE TABLE "Movements"(
   Movement_id SERIAL PRIMARY KEY NOT NULL,
   Account_id                 INT NOT NULL,
   Amount                 NUMERIC NOT NULL,
   Created_at           TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP),
CONSTRAINT Movements_Accounts_fkey FOREIGN KEY (Account_id)
    REFERENCES "Accounts" (Account_id) MATCH SIMPLE
    ON UPDATE NO ACTION ON DELETE NO ACTION
);  
    
CREATE TABLE "Transfers"(
    Transfer_id SERIAL PRIMARY KEY NOT NULL,
    Amount                 NUMERIC NOT NULL,
    From_account_id            INT NOT NULL,
    To_account_id              INT NOT NULL,
    Request_date         TIMESTAMP NOT NULL DEFAULT (CURRENT_TIMESTAMP),
CONSTRAINT Check_Transfers_Amount_Positive            CHECK (Amount > 0),
CONSTRAINT Check_Transfers_FromAccountId_NaturalNum   CHECK (From_account_id > 0),
CONSTRAINT Check_Transfers_ToAccountId_NaturalNum     CHECK (To_account_id  > 0),
CONSTRAINT Check_Transfers_FromAndToAccounts_NotEqual CHECK (From_account_id <> To_account_id)
);  

CREATE TABLE "Sessions"(
   Session_id        TEXT PRIMARY KEY NOT NULL DEFAULT (gen_random_uuid()::text),   --
   User_id                        INT NOT NULL, 
   Active                        BOOL NOT NULL,
   Created_at               TIMESTAMP NOT NULL,
   Access_token                  TEXT NOT NULL,
   Access_token_expires_at  TIMESTAMP NOT NULL,
   Refresh_token                 TEXT NOT NULL,
   Refresh_token_expires_at TIMESTAMP NOT NULL,
CONSTRAINT Sessions_Users_fkey FOREIGN KEY (User_id)
    REFERENCES "Users" (User_id) MATCH SIMPLE
    ON UPDATE NO ACTION ON DELETE NO ACTION
);

    
INSERT INTO "Users" -- User_id | Email | Fullname | "Password" | Salt | Username | Created_at | Password_changed_at
           (Email, Fullname, "Password", Salt, Username, Created_at, Password_changed_at)
    VALUES ( 'AntSantos32@hotmail.com', 'Antonio Albuquerque Santos', '1533361BC39659153BC59234C5BEC3B317C2A0E280A275C39F5AE280B05FC2AD3E32001657C2BD15C38CC3B714C2AD3F1FC3AD11C396C380E2809D56C3ACC383C2B9C3BAC2BDC2B4C2ADC5937C7DC381C3ACC2ACE280B96E184A300E58C2B7C2B36C7A000000000000000000000000000000000000000000000000000000000000000000000000000000000000', 'ZKGH',    'AntSantos32', DEFAULT, DEFAULT), 
           ('VanessaAmSilva@gmail.com',    'Vanessa Amaral da Silva', '1533361BC39659153BC59234C5BEC3B317C2A0E280A275C39F5AE280B05FC2AD3E32001657C2BD15C38CC3B714C2AD3F1FC3AD11C396C380E2809D56C3ACC383C2B9C3BAC2BDC2B4C2ADC5937C7DC381C3ACC2ACE280B96E184A300E58C2B7C2B36C7A000000000000000000000000000000000000000000000000000000000000000000000000000000000000', 'ZKGH', 'VanessaAmSilva', DEFAULT, DEFAULT), 
           (  'MConceicao55@gmail.com',         'Maria da Conceicao', '1533361BC39659153BC59234C5BEC3B317C2A0E280A275C39F5AE280B05FC2AD3E32001657C2BD15C38CC3B714C2AD3F1FC3AD11C396C380E2809D56C3ACC383C2B9C3BAC2BDC2B4C2ADC5937C7DC381C3ACC2ACE280B96E184A300E58C2B7C2B36C7A000000000000000000000000000000000000000000000000000000000000000000000000000000000000', 'ZKGH',   'MConceicao55', DEFAULT, DEFAULT); 
    
INSERT INTO "Accounts" -- Account_id | User_id | Balance | Created_at | Currency
           (User_id, Balance, Created_at, Currency)
    VALUES ( 1, 50000.33, DEFAULT, DEFAULT), --1 Account_id
           ( 1,  7562.53, DEFAULT, DEFAULT), --2
           ( 2, 95032.87, DEFAULT, DEFAULT), --3
           ( 2, 15552.68, DEFAULT, DEFAULT), --4
           ( 2,  3202.66, DEFAULT, DEFAULT), --5
           ( 3,  6580.67, DEFAULT, DEFAULT), --6
           ( 3,  3235.10, DEFAULT, DEFAULT), --7
           ( 3,  6625.00, DEFAULT, DEFAULT); --8
    
INSERT INTO "Movements" -- Movement_id | Account_id | Amount | Created_at
           (Account_id, Amount, Created_at)
    VALUES (1,  -500.50, NOW() - INTERVAL '2 MONTH' - INTERVAL '9 DAY'), --1 Movement_id
           (2,   500.50, NOW() - INTERVAL '2 MONTH' - INTERVAL '9 DAY'), --2
           (1, -1000.80, NOW() - INTERVAL '1 MONTH' + INTERVAL '2 DAY'), --3
           (3,  1000.80, NOW() - INTERVAL '1 MONTH' + INTERVAL '2 DAY'), --4 
           (1,  -700.10, NOW() - INTERVAL  '29 DAY'), --5
           (4,   700.10, NOW() - INTERVAL  '29 DAY'), --6 
           (1,  -100.15, NOW() - INTERVAL  '23 DAY'), --7
           (5,   100.15, NOW() - INTERVAL  '23 DAY'), --8
           (1, -2000.66, NOW() - INTERVAL  '19 DAY'), --9  
           (8,  2000.66, NOW() - INTERVAL  '19 DAY'), --10
           (2, -1000.88, NOW() - INTERVAL  '17 DAY'), --11
           (1,  1000.88, NOW() - INTERVAL  '17 DAY'), --12    
           (2, -1200.50, NOW() - INTERVAL  '15 DAY'), --13
           (3,  1200.50, NOW() - INTERVAL  '15 DAY'), --14
           (2,  -500.50, NOW() - INTERVAL  '12 DAY'), --15 
           (5,   500.50, NOW() - INTERVAL  '12 DAY'), --16
           (2, -2000.75, NOW() - INTERVAL   '9 DAY'), --17
           (7,  2000.75, NOW() - INTERVAL   '9 DAY'), --18 
           (2, -2500.25, NOW() - INTERVAL   '7 DAY'), --19
           (8,  2500.25, NOW() - INTERVAL   '7 DAY'), --20         
           (3,   -10.99, NOW() - INTERVAL   '5 DAY'), --21
           (2,    10.99, NOW() - INTERVAL   '5 DAY'), --22
           (3,   220.89, NOW() - INTERVAL   '4 DAY'), --23 
           (4,  -220.89, NOW() - INTERVAL   '4 DAY'), --24 
           (3,  -200.20, NOW() - INTERVAL   '2 DAY'), --25
           (6,   200.20, NOW() - INTERVAL   '2 DAY'), --26
           (3,  -400.55, NOW() - INTERVAL   '1 DAY'), --27
           (8,   400.55, NOW() - INTERVAL   '1 DAY'); --28

INSERT INTO "Transfers" -- Transfer_id | Amount | From_account_id | To_account_id | Request_date
           (Amount, From_account_id, To_account_id, Request_date)
    VALUES (  500.50, 1, 2, NOW() - INTERVAL '2 MONTH' - INTERVAL '9 DAY'), --1 Transfer_id
           ( 1000.80, 1, 3, NOW() - INTERVAL '1 MONTH' + INTERVAL '2 DAY'), --2
           (  700.10, 1, 4, NOW() - INTERVAL  '29 DAY'), --3
           (  100.15, 1, 5, NOW() - INTERVAL  '23 DAY'), --4
           ( 2000.66, 1, 8, NOW() - INTERVAL  '19 DAY'), --5
           ( 1000.88, 2, 1, NOW() - INTERVAL  '17 DAY'), --6
           ( 1200.50, 2, 3, NOW() - INTERVAL  '15 DAY'), --7
           (  500.50, 2, 5, NOW() - INTERVAL  '12 DAY'), --8
           ( 2000.75, 2, 7, NOW() - INTERVAL   '9 DAY'), --9
           ( 2500.25, 2, 8, NOW() - INTERVAL   '7 DAY'), --10   
           (   10.99, 3, 2, NOW() - INTERVAL   '5 DAY'), --11
           (  220.89, 3, 4, NOW() - INTERVAL   '4 DAY'), --12
           (  200.20, 3, 6, NOW() - INTERVAL   '2 DAY'), --13 
           (  400.55, 3, 8, NOW() - INTERVAL   '1 DAY'); --14


